function nachiLinkService(a,b,c,d,e,f,g,h,i,j){function k(a){if(l.isNachiLinkTopic(a)){if(l.isCompressed(a))return void l.decompressTopic(a);if(-1===l.initalizedNachiVars.indexOf(a)){l.initalizedNachiVars.push(a);var b=c.$watchGroup([function(){return d.services},function(){return d.services.length}],function(){d.nodes[a.nodeName].Subscribe&&d.nodes[a.nodeName].Subscribe.call({variable_name:a.shortPath.substring(10)},function(c){a.subscribed&&(a.listener?d.nodes[a.nodeName].Subscribe.call({variable_name:a.shortPath.substring(10)}):a.subscribe(function(){setTimeout(function(){d.nodes[a.nodeName].Subscribe.call({variable_name:a.shortPath.substring(10)})},1e3)})),b()})})}else d.nodes[a.nodeName].Subscribe.call({variable_name:a.shortPath.substring(10)})}}var l={visible:!1,setVisible:function(a,b){l.visible=a,b&&(l.node=b),a&&l.init()},selectedVariable:null,node:null,trySubscribe:function(a,c,e,f,g){30==a?b.show(f?localization.currentLocal.fidgets.extend.variableSelector.subFailed:localization.currentLocal.fidgets.extend.variableSelector.unsubFailed):setTimeout(function(){var h=!1;angular.forEach(d.topics,function(a){a.path!="/"+e+"/Variables/"+c||d.nodes[e].isCompressed?a.path=="/"+e+"/Variables/Compressed"&&(d.nodes[e].isCompressed=!0,a.subscribed||(a.subscribed=!0),a.value&&angular.forEach(a.value.values,function(a){a.name==c&&(h=!0,g||b.show(f?localization.format(localization.currentLocal.fidgets.extend.variableSelector.subEnd,[c,e]):localization.format(localization.currentLocal.fidgets.extend.variableSelector.unsubEnd,[c,e])))})):(a.subscribed=f,h=!0,g||b.show(f?localization.format(localization.currentLocal.fidgets.extend.variableSelector.subEnd,[c,e]):localization.format(localization.currentLocal.fidgets.extend.variableSelector.unsubEnd,[c,e])))}),h?l.checkSubscription():l.trySubscribe(a+1,c,e,f,g)},500)},decompressTopic:function(a){a.onChangeFunctions.compressWatch=function(b){angular.forEach(a.value.values,function(b){var c="/"+a.nodeName+"/Variables/"+b.name,e=d.getInterface(c);if(e||(e=new d.Topic(c,"nachi_tools/Variable"),e.temp=!0,d.addNewInterface(e),e=d.getInterface(c)),e.subscribed||(e.subscribed=!0),!e.temp){var g=f.interfaceMetaData.list.find(function(a){return a.path==c});g&&d.setTopicFromMeta(e,g),e.temp=!0}e.isOffline=!1,e.setValue({value:b.value})})}},subscribeVariable:function(a,e){if(d.nodes[l.node.__name]&&d.nodes[l.node.__name].Variables&&l.selectedVariable){var f=l.getVariableName(),g=l.node.__name;d.nodes[l.node.__name].Subscribe.call({variable_name:f},function(d){c.$apply(function(){e||b.show(a?localization.format(localization.currentLocal.fidgets.extend.variableSelector.subStart,[f,g]):localization.format(localization.currentLocal.fidgets.extend.variableSelector.unsubStart,[f,g])),l.trySubscribe(0,f,g,a,e)})})}},loadVariables:function(){d.nodes[l.node.__name]&&d.nodes[l.node.__name].Variables&&(a[l.node.__name]||(a[l.node.__name]={}),a[l.node.__name].variableList=[],d.nodes[l.node.__name].Variables.call({},function(b){angular.forEach(b.variables,function(b){a[l.node.__name].variableList.push({name:b,subscribed:!1})}),a[l.node.__name].variableList.length>0&&(l.selectedVariable=a[l.node.__name].variableList[0]),l.checkSubscription()}))},initalizedNachiVars:[],unbindWatch:null,init:function(){l.loadVariables(),l.unbindWatch=c.$watchGroup([function(){return d.topics},function(){return d.topics.length}],function(){l.checkSubscription()})},isCompressed:function(a){return["nachi_tools/ListValues"].indexOf(a.type)>-1?!0:!1},isNachiLinkTopic:function(a){return["nachi_tools/Variable","nachi_tools/ListValues","nachi_tools/Decompressed"].indexOf(a.type)>-1?!0:!1},checkSubscription:function(){if(d.nodes[l.node.__name]&&d.nodes[l.node.__name].Variables&&l.selectedVariable){var a=[];angular.forEach(d.topics,function(b){b.subscribed&&a.push(b.path)}),this.selectedVariable.subscribed=a.indexOf("/"+l.node.__name+"/Variables/"+this.getVariableName())>-1}},testing:!1,getVariableName:function(){if(l.paramSelectors&&l.paramSelectors.length>0){var a="";return angular.forEach(l.paramSelectors,function(b){a+=b.name+b.selectedValue}),a}return l.selectedVariable.name},isParamsValid:function(){var a=!0;return l.paramSelectors&&l.paramSelectors.length>0&&angular.forEach(l.paramSelectors,function(b){-1==b.items.indexOf(b.selectedValue)&&(a=!1)}),a},getParameters:function(a){function b(a,b){var c=[];if(isNaN(parseInt(a))||isNaN(parseInt(b)))for(var d="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",e=d.indexOf(a);e<=d.indexOf(b);e++)c.push(d[e]);else for(var e=a;b>=e;e++)c.push(e.toString());return c}if(a){var c=a.name,d=a.name.match(/\[(.*?)\]/g);if(!d||0==d.length)return[];for(var e=0,f=[];f.length!=d.length;){var g=d[f.length],h=c.indexOf(g),i=c.substring(e,h),j=g.substring(1,g.length-1).split(".."),k=b(j[0],j[1]);e=h+g.length,f.push({name:i,items:k,selectedValue:k[0]})}return f}}};return c.$watch(function(){return l.selectedVariable},function(a){a&&(l.paramSelectors=l.getParameters(a),l.checkSubscription())}),c.addModal("nachiLinkWindow",e.trustAsResourceUrl(c.addonServerUrl+"addons/nachiLink/views/nachiLinkWindow.html"),"$rootScope.nachiLink.visible"),c.nodeExtras.push('<button class="btn btn-default" ng-if="settings.nodesTabSelectedItem.Variables && settings.nodesTabSelectedItem.Unsubscribe && settings.nodesTabSelectedItem.Subscribe" ng-click="nachiLink.setVisible(true, settings.nodesTabSelectedItem)">'+localization.currentLocal.nachiLink.addVariable+"</button>"),c.$watchGroup([function(){return d.topics},function(){return d.topics.length}],function(){angular.forEach(d.topics,function(a){k(a)})}),d.subscribeCallbacks.push(function(a){setTimeout(function(){k(a)},1e3)}),d.topicSetters.nachi_tools=function(a,b){d.nodes[a.nodeName].ChangeVariable.call({name:a.shortPath.substring(10),value:b.value.toString()})},l}nachiLinkService.$inject=["variableService","popupService","$rootScope","deviceService","$sce","projectService","fidgetService","settingsWindowService","projectStorageService","$timeout"];