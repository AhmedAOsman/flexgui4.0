function slamMapCtrl(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){function q(a){return a.x+=x.offset.x,a.y+=x.offset.y,pointReal={x:a.x*Math.cos(x.angle)-a.y*Math.sin(x.angle),y:a.x*Math.sin(x.angle)+a.y*Math.cos(x.angle)},pointReal.x*=x.scale,pointReal.y*=x.scale,pointReal}function r(a){return a.x/=x.scale,a.y/=x.scale,pointMap={x:a.x*Math.cos(x.angle)+a.y*Math.sin(x.angle),y:-a.x*Math.sin(x.angle)+a.y*Math.cos(x.angle)},pointMap.x-=x.offset.x,pointMap.y-=x.offset.y,pointMap}var s,t,u,v,w={width:100,height:100},x={offset:{x:0,y:0},scale:1,angle:0};c.robot={icon:b.trustAsResourceUrl(p.addonServerUrl+"addons/extendedFidgets/images/robot.png"),top:-10,left:-10,b64:null},c.currentFidget=null,c.loaded=!1,c.slamLogo=b.trustAsResourceUrl(p.addonServerUrl+"addons/extendedFidgets/images/fidgets/slam.png"),c.destination={icon:b.trustAsResourceUrl(p.addonServerUrl+"addons/extendedFidgets/images/destination.png"),top:0,left:0,show:!1,b64:null},c.recorded=!1;var y=function(a){if(C){var b=q(a);C.publish(new ROSLIB.Message({x:b.x,y:b.y,z:0})),c.destination.top=parseInt(a.y*c.currentFidget.properties.height/w.height),c.destination.left=parseInt(a.x*c.currentFidget.properties.width/w.width),c.destination.show=!0,z()}},z=function(a){var b=c.currentFidget,d=c.destination,e=c.robot,f=document.getElementById("slamCanvas_"+b.id);if(f){var g=f.getContext("2d"),h=new Image;h.onload=function(){g.clearRect(0,0,f.width,f.height),g.save(),g.translate(b.properties.width/2+b.properties.hpan,b.properties.height/2+b.properties.vpan),g.rotate(b.properties.angle*Math.PI/180),g.translate(-b.properties.width/2,-b.properties.height/2),g.drawImage(h,0,0,w.width,w.height,0,0,b.properties.width*b.properties.zoom,b.properties.height*b.properties.zoom);b.properties.width/b.properties.height,w.width/w.height;e.image&&e.left>-1&&e.top>-1&&g.drawImage(e.image,0,0,w.width,w.height,(e.left-e.image.width*(b.properties.width/w.width)/2)*b.properties.zoom,(e.top-e.image.height*(b.properties.height/w.height))*b.properties.zoom,b.properties.width*b.properties.zoom,b.properties.height*b.properties.zoom),d.image&&d.show&&g.drawImage(d.image,0,0,w.width,w.height,(d.left-d.image.width*(b.properties.width/w.width)/2)*b.properties.zoom,(d.top-d.image.height*(b.properties.height/w.height))*b.properties.zoom,b.properties.width*b.properties.zoom,b.properties.height*b.properties.zoom),g.restore(),c.loaded=!0,c.$apply()},h.src=v}},A=function(a){var b=new Image;b.src=a.icon,b.onload=function(){a.image=angular.copy(b),$("#temp_Canvas").remove()}},B=null,C=null,D=null;c.initMapFidget=function(a){function b(a){var b=a.originalEvent.changedTouches[0],d={clientX:b.clientX,clientY:b.clientY,screenX:b.screenX,screenY:b.screenY,offsetX:b.screenX-$("#"+c.currentFidget.id).offset().left,offsetY:b.screenY-$("#"+c.currentFidget.id).offset().top,touch:!0,touches:a.originalEvent.touches};return d}if(a){c.currentFidget=a,c.$watch(function(){return l.loaded},function(){A(c.robot),A(c.destination),o(function(){a=l.getFidgetById(a.id),t=document.createElement("canvas"),u=t.getContext("2d"),j.callService("/static_map",{},function(a){s=a.map,w.width=a.map.info.width,w.height=a.map.info.height,t.width=w.width,t.height=w.height;var b=u.createImageData(w.width,w.height);angular.forEach(s.data,function(a,c){var d=-1==a?255:parseInt(255-255*a/100);b.data[4*c]=d,b.data[4*c+1]=d,b.data[4*c+2]=d,b.data[4*c+3]=-1==a?0:255}),u.putImageData(b,0,0),v=t.toDataURL("image/png"),z()}),$("#slamCanvas_"+a.id).mousemove(d.move).mousedown(d.down).mouseup(d.up).mouseleave(d.up).click(d.click).bind("touchmove",function(a){d.move(b(a))}).bind("touchstart",function(a){d.down(b(a))}).bind("touchend",function(a){d.up(b(a))}).bind("touchleave",function(a){d.up(b(a))}),B=new ROSLIB.Topic({name:a.properties.positionTopicName,messageType:"geometry_msgs/Vector3"}),B.ros=m.ros,B.advertise()},500),c.$watchGroup([function(){return a.properties.width},function(){return a.properties.height}],function(){var a=c.destination,b=c.robot;b.top=-1,b.left=-1,a.show=!1,z()}),c.$watch(function(){return a.properties.positionTopicName},function(b,d){d&&B&&B.unsubscribe(),b&&(B=new ROSLIB.Topic({ros:m.ros,name:a.properties.positionTopicName,messageType:"geometry_msgs/Vector3"}),B.subscribe(function(a){var b=r(a);D=a;var d=c.robot,e=(c.destination,c.currentFidget);d.top=b.y*e.properties.height/w.height,d.left=b.x*e.properties.width/w.width,z()}))}),c.$watch(function(){return a.properties.destinationTopicName},function(b,c){c&&C&&C.unadvertise(),b&&(C=new ROSLIB.Topic({name:a.properties.destinationTopicName,messageType:"geometry_msgs/Vector3",ros:m.ros}),C.advertise())}),c.$watchGroup([function(){return a.properties.angle},function(){return a.properties.zoom},function(){return a.properties.hpan},function(){return a.properties.vpan}],function(a){z()})});var d={mouseDown:!1,moved:!1,downPos:null,lastEvt:null,lastDistance:null,distance:null,down:function(a){this.mouseDown=!0,this.downPos={x:a.offsetX,y:a.offsetY},this.originalProperties={hpan:c.currentFidget.properties.hpan,vpan:c.currentFidget.properties.vpan,angle:c.currentFidget.properties.angle,zoom:c.currentFidget.properties.zoom}},move:function(a){if(this.mouseDown){var b=a.ctrlKey,e=a.shiftKey;if(a.touches&&a.touches.length>1){if(!this.lastEvt)return void(this.lastEvt=a);var f=this.lastEvt.touches,g=a.touches;if(Math.abs(f[0].clientX-g[0].clientX)<5&&Math.abs(f[0].clientY-g[0].clientY)<5&&Math.abs(f[1].clientX-g[1].clientX)<5&&Math.abs(f[1].clientY-g[1].clientY)<5)return;var h=Math.sqrt(Math.pow(f[0].clientX-f[1].clientX,2)+Math.pow(f[0].clientY-f[1].clientY,2)),i=Math.sqrt(Math.pow(g[0].clientX-g[1].clientX,2)+Math.pow(g[0].clientY-g[1].clientY,2));Math.abs(h-i)>5?(b=!0,null!==this.distance&&(this.lastDistance=this.distance),this.distance=i):e=!0,this.lastEvt=a}(Math.abs(a.offsetX-this.downPos.x)>5||Math.abs(a.offsetY-this.downPos.y)>5)&&(d.moved=!0,b?c.currentFidget.properties.zoom=a.touches&&a.touches.length>1?null!==this.lastDistance&&null!==this.distance?Math.min(10,Math.max(0,this.originalProperties.zoom+(this.distance-this.lastDistance)/50)):this.originalProperties.zoom:Math.min(10,Math.max(0,this.originalProperties.zoom+(a.offsetX-this.downPos.x)/50)):e?(c.currentFidget.properties.angle=parseInt(this.originalProperties.angle+Math.sqrt(Math.pow(a.offsetX,2)+Math.pow(a.offsetY,2))),c.currentFidget.properties.angle>360&&(c.currentFidget.properties.angle-=360),c.currentFidget.properties.angle<0&&(c.currentFidget.properties.angle+=350)):a.touches&&1!=a.touches.length||(c.currentFidget.properties.hpan=a.offsetX-this.downPos.x+this.originalProperties.hpan,c.currentFidget.properties.vpan=a.offsetY-this.downPos.y+this.originalProperties.vpan))}},up:function(a){this.mouseDown=!1,delete this.lastEvt,window.setTimeout(function(){d.moved=!1},200)},click:function(a){function b(a,b,c,d,e){e=[null,void 0,"undefined","NaN"].indexOf(e)>-1?0:e;var f=Math.PI/180*e,g=Math.cos(f),h=Math.sin(f),i=g*(c-a)+h*(d-b)+a,j=g*(d-b)-h*(c-a)+b;return{x:i,y:j}}if(!d.moved){var e={x:a.offsetX-c.currentFidget.properties.hpan,y:a.offsetY-c.currentFidget.properties.vpan};e=b(c.currentFidget.properties.width/2,c.currentFidget.properties.height/2,e.x,e.y,c.currentFidget.properties.angle),e.x=e.x/c.currentFidget.properties.zoom,e.y=e.y/c.currentFidget.properties.zoom;var f={x:parseInt(e.x*w.width/c.currentFidget.properties.width),y:parseInt(e.y*w.height/c.currentFidget.properties.height)};if(c.currentFidget.properties.isCalibrationOn){c.currentFidget.properties.calibrationPoints||(c.currentFidget.properties.calibrationPoints="[]");var g=JSON.parse(c.currentFidget.properties.calibrationPoints);g.push({map:f,world:D}),c.currentFidget.properties.calibrationPoints=JSON.stringify(g),c.recorded=!0,o(function(){c.recorded=!1},1e3)}else y(f)}}}}}}slamMapCtrl.$inject=["$http","$sce","$scope","$window","$location","$routeParams","$attrs","editorService","popupService","deviceService","scriptManagerService","projectService","variableService","settingsWindowService","$timeout","$rootScope"];